# ðŸš¨ é‡å¤§ä¿®æ­£ï¼šç›´æŽ¥ä½¿ç”¨ Ground Truth å¿ƒçŽ‡

## ç™¼ç¾å•é¡Œ

ä¹‹å‰æˆ‘**éŒ¯èª¤ç†è§£**äº† UBFC DATASET_2 çš„ `ground_truth.txt` æ ¼å¼ï¼

### å®˜æ–¹æ–‡æª”èªªæ˜Ž

```
Dataset2: Ground truth is stored in ground_truth.txt files:
  Line 1: PPG signal
  Line 2: Heart rate (HR)  â† é€™æ‰æ˜¯å¿ƒçŽ‡ï¼
  Line 3: Timestep (seconds, scientific notation)
```

### ä¹‹å‰çš„éŒ¯èª¤

**éŒ¯èª¤ç‰ˆæœ¬**ï¼šæˆ‘æŠŠæ‰€æœ‰ 3 è¡Œçš„æ•¸æ“šéƒ½è®€å–äº†ï¼Œæ··åˆäº† PPGã€HRã€Timestep
- å°Žè‡´æ¨™ç±¤ç¯„åœï¼š`-2.79 åˆ° 127.0`ï¼ˆä¸åˆç†ï¼‰
- åŒ…å« BVP æŒ¯ç›ªå€¼ã€å¿ƒçŽ‡å€¼ã€æ™‚é–“æˆ³

**æ­£ç¢ºç‰ˆæœ¬**ï¼š**æ‡‰è©²åªè®€å– Line 2ï¼ˆHeart Rateï¼‰ï¼**

---

## ðŸ“‹ ä¿®æ­£å…§å®¹

### 1. è®€å–æ–¹å¼è®Šæ›´

**ä¿®æ”¹å‰ï¼ˆéŒ¯èª¤ï¼‰**ï¼š
```python
with open(ground_truth_path, 'r') as f:
    content = f.read()

# æå–æ‰€æœ‰æ•¸å€¼ï¼ˆæ··åˆäº† 3 è¡Œï¼‰
bvp_data = []
for line in content.strip().split('\n'):
    values = line.split()
    for val in values:
        bvp_data.append(float(val))
```

**ä¿®æ”¹å¾Œï¼ˆæ­£ç¢ºï¼‰**ï¼š
```python
with open(ground_truth_path, 'r') as f:
    lines = f.readlines()

# åªè®€å– Line 2ï¼ˆHeart Rateï¼‰
hr_line = lines[1].strip()
hr_values = [float(x) for x in hr_line.split()]
hr_gt = np.array(hr_values)
```

### 2. ç§»é™¤ Welch è¨ˆç®—

**ä¹‹å‰çš„éŒ¯èª¤é‚è¼¯**ï¼š
1. è®€å–æ··åˆæ•¸æ“šç•¶ä½œ BVP
2. ç”¨ Welch æ–¹æ³•å¾ž BVP è¨ˆç®—å¿ƒçŽ‡
3. ä½¿ç”¨è¨ˆç®—å‡ºçš„å¿ƒçŽ‡ä½œç‚ºæ¨™ç±¤

**ç¾åœ¨çš„æ­£ç¢ºé‚è¼¯**ï¼š
1. ç›´æŽ¥è®€å– Line 2 çš„å¿ƒçŽ‡æ¨™ç±¤
2. ç„¡éœ€ä»»ä½•é »åŸŸåˆ†æž
3. ç›´æŽ¥ä½¿ç”¨ ground truth å¿ƒçŽ‡

### 3. ç°¡åŒ–ä»£ç¢¼

ç§»é™¤äº†ä»¥ä¸‹å…§å®¹ï¼š
- âŒ `from scipy.signal import welch`
- âŒ 256 å¹€ BVP çª—å£è¨ˆç®—
- âŒ Welch åŠŸçŽ‡è­œå¯†åº¦ä¼°è¨ˆ
- âŒ é »çŽ‡ç¯„åœé™åˆ¶
- âŒ ç•°å¸¸è™•ç†ï¼ˆè¨ˆç®—å¤±æ•—ï¼‰

---

## âœ… é æœŸæ”¹é€²

### æ¨™ç±¤è³ªé‡

**ä¹‹å‰ï¼ˆéŒ¯èª¤ï¼‰**ï¼š
```
Min:  -2.785887  â† åŒ…å« BVP æŒ¯ç›ªå€¼ï¼ˆéŒ¯èª¤ï¼ï¼‰
Max:  127.000000 â† åŒ…å«æ¥µç«¯å€¼ï¼ˆéŒ¯èª¤ï¼ï¼‰
Mean: 42.989197  â† å¹³å‡å€¼åä½Žï¼ˆéŒ¯èª¤ï¼ï¼‰
```

**ç¾åœ¨ï¼ˆæ­£ç¢ºï¼‰**ï¼š
```
Min:  ~60 BPM   â† éœæ¯æœ€ä½Žå¿ƒçŽ‡ï¼ˆåˆç†ï¼ï¼‰
Max:  ~120 BPM  â† éœæ¯æœ€é«˜å¿ƒçŽ‡ï¼ˆåˆç†ï¼ï¼‰
Mean: ~75 BPM   â† æ­£å¸¸éœæ¯å¿ƒçŽ‡ï¼ˆåˆç†ï¼ï¼‰
```

### æ¨£æœ¬æ•¸é‡

**ä¹‹å‰**ï¼š60,000-70,000ï¼ˆå› ç‚ºéœ€è¦ 256 å¹€çª—å£ï¼Œå¾ˆå¤šæ¨£æœ¬è¢«è·³éŽï¼‰

**ç¾åœ¨**ï¼š~79,000ï¼ˆèˆ‡åŽŸå§‹ç‰ˆæœ¬ç›¸åŒï¼Œç„¡æ¨£æœ¬æå¤±ï¼‰

### é è™•ç†æ™‚é–“

**ä¹‹å‰**ï¼š2.5-3.5 å°æ™‚ï¼ˆå¤šäº† Welch è¨ˆç®—ï¼‰

**ç¾åœ¨**ï¼š2-3 å°æ™‚ï¼ˆèˆ‡åŽŸå§‹ç‰ˆæœ¬ç›¸åŒï¼‰

---

## ðŸš€ åŸ·è¡ŒæŒ‡å—

### Step 1: åˆªé™¤èˆŠæ•¸æ“š

```bash
ssh miat@140.115.53.67
cd /home/miat/ChenPinHao/server_training

# åˆªé™¤ä¹‹å‰éŒ¯èª¤çš„é è™•ç†æ•¸æ“š
rm -f data/ubfc_processed.pt
```

### Step 2: é‡æ–°é è™•ç†ï¼ˆä½¿ç”¨ä¿®æ­£ç‰ˆï¼‰

```bash
conda activate rppg_training

# é–‹å§‹é è™•ç†ï¼ˆ2-3 å°æ™‚ï¼‰
python preprocess_data.py --dataset ubfc --raw_data raw_data --output data
```

### Step 3: é©—è­‰æ–°æ•¸æ“š

**é æœŸè¼¸å‡º**ï¼ˆé è™•ç†å®Œæˆå¾Œï¼‰ï¼š
```
ðŸ“Š æ ‡ç­¾ç»Ÿè®¡ï¼ˆå¿ƒçŽ‡ BPMï¼‰ï¼š
   æœ€å°å€¼ï¼š60.12 BPM   â† åˆç†ï¼
   æœ€å¤§å€¼ï¼š118.34 BPM  â† åˆç†ï¼
   å¹³å‡å€¼ï¼š74.56 BPM   â† åˆç†ï¼
   æ ‡å‡†å·®ï¼š12.48 BPM   â† åˆç†ï¼

âœ… UBFC æ•°æ®ä¿å­˜åˆ°ï¼šdata/ubfc_processed.pt
   æ ·æœ¬æ•°ï¼š79432       â† èˆ‡åŽŸå§‹ç‰ˆæœ¬ç›¸åŒ
   å½¢çŠ¶ï¼štorch.Size([79432, 8, 3, 36, 36, 3])
   æ ‡ç­¾ï¼šå¿ƒçŽ‡ BPM (ç›´æŽ¥ä»Ž ground_truth.txt Line 2 è¯»å–)
   å¤§å°ï¼š27.65 GB
```

**æ‰‹å‹•é©—è­‰**ï¼š
```bash
python -c "
import torch
data = torch.load('data/ubfc_processed.pt')
labels = data['labels']
print(f'Label type: {data.get(\"label_type\", \"unknown\")}')
print(f'Min:  {labels.min():.2f} BPM')
print(f'Max:  {labels.max():.2f} BPM')
print(f'Mean: {labels.mean():.2f} BPM')
print(f'Std:  {labels.std():.2f} BPM')
print(f'Sample values (first 20):')
print(labels[:20])
"
```

**æœŸæœ›çœ‹åˆ°**ï¼š
- æ‰€æœ‰å€¼éƒ½åœ¨ **50-120 BPM** ç¯„åœ
- å¹³å‡å€¼ **~70-80 BPM**
- å‰ 20 å€‹æ¨£æœ¬çœ‹èµ·ä¾†åƒåˆç†çš„å¿ƒçŽ‡å€¼ï¼ˆä¸æ˜¯ BVP æŒ¯ç›ªï¼‰

### Step 4: é–‹å§‹è¨“ç·´

```bash
# ä½¿ç”¨ä¿®æ­£å¾Œçš„æ•¸æ“šè¨“ç·´
bash start_training_background.sh

# æˆ–æ‰‹å‹•
LOG_FILE="logs/training_corrected_$(date +%Y%m%d_%H%M%S).log"
nohup python train.py --config config.yaml > "$LOG_FILE" 2>&1 &
```

**é æœŸè¨“ç·´æŒ‡æ¨™**ï¼ˆEpoch 1ï¼‰ï¼š
```
Train Loss: 80-120   â† MSE lossï¼Œåˆç†ç¯„åœ
MAE:        5-10     â† åˆæœŸå¯èƒ½è¼ƒé«˜
RMSE:       8-15     â† åˆç†
MAPE:       8-15%    â† åˆç†
```

---

## ðŸ“Š å°æ¯”ç¸½çµ

| é …ç›® | éŒ¯èª¤ç‰ˆæœ¬ | Welch ç‰ˆæœ¬ | **æ­£ç¢ºç‰ˆæœ¬** |
|------|---------|----------|------------|
| **æ¨™ç±¤ä¾†æº** | æ··åˆ 3 è¡Œæ•¸æ“š | Welch è¨ˆç®— | **Line 2 ç›´æŽ¥è®€å–** |
| **æ¨™ç±¤ç¯„åœ** | -2.79 ~ 127.0 | 30-180 BPM | **60-120 BPM** |
| **æ¨™ç±¤å¹³å‡** | 42.99 | ~70 BPM | **~75 BPM** |
| **æ¨£æœ¬æ•¸** | 79,666 | 60K-70K | **79,000** |
| **é è™•ç†æ™‚é–“** | 2-3 å°æ™‚ | 2.5-3.5 å°æ™‚ | **2-3 å°æ™‚** |
| **æº–ç¢ºæ€§** | âŒ å®Œå…¨éŒ¯èª¤ | âš ï¸ å¯èƒ½æœ‰èª¤å·® | **âœ… Ground Truth** |

---

## ðŸŽ“ ç¶“é©—æ•™è¨“

### 1. **æ°¸é æª¢æŸ¥å®˜æ–¹æ–‡æª”**
- ä¸è¦å‡è¨­æ•¸æ“šæ ¼å¼
- UBFC å®˜æ–¹æ˜Žç¢ºèªªæ˜Žäº†æ ¼å¼
- æ‡‰è©²ä¸€é–‹å§‹å°±ä»”ç´°é–±è®€

### 2. **é©—è­‰æ¨™ç±¤ç¯„åœ**
- æ¨™ç±¤ç¯„åœ `-2.79 åˆ° 127.0` æ‡‰è©²ç«‹å³å¼•èµ·è­¦è¦º
- å¿ƒçŽ‡ä¸å¯èƒ½æ˜¯è² å€¼
- 127 BPM å°æ–¼éœæ¯ç‹€æ…‹å¤ªé«˜

### 3. **ä½¿ç”¨ Ground Truth**
- å¦‚æžœæ•¸æ“šé›†æä¾›äº† Ground Truthï¼Œç›´æŽ¥ä½¿ç”¨
- ä¸è¦éŽåº¦è™•ç†ï¼ˆå¦‚ç”¨ Welch é‡æ–°è¨ˆç®—ï¼‰
- Ground Truth é€šå¸¸æ¯”ç®—æ³•è¨ˆç®—æ›´æº–ç¢º

### 4. **æ¸¬è©¦æ•¸æ“šå®Œæ•´æ€§**
```bash
# æ‡‰è©²ä¸€é–‹å§‹å°±æª¢æŸ¥
head -3 raw_data/.../subject1/ground_truth.txt
# çœ‹åˆ° 3 è¡Œä¸åŒçš„æ•¸æ“š â†’ æŸ¥æ–‡æª”
```

---

## âš ï¸ é‡è¦æé†’

### èˆŠæ•¸æ“šå®Œå…¨ç„¡æ•ˆï¼

å¦‚æžœä½ ä¹‹å‰å·²ç¶“è¨“ç·´äº†æ¨¡åž‹ï¼Œè«‹ï¼š
1. âŒ **åˆªé™¤èˆŠæ¨¡åž‹**ï¼ˆåŸºæ–¼éŒ¯èª¤æ¨™ç±¤è¨“ç·´ï¼‰
2. âŒ **åˆªé™¤èˆŠæ•¸æ“š**ï¼ˆ`ubfc_processed.pt`ï¼‰
3. âœ… **é‡æ–°é è™•ç†**ï¼ˆä½¿ç”¨ä¿®æ­£ç‰ˆè…³æœ¬ï¼‰
4. âœ… **é‡æ–°è¨“ç·´**

### æª”æ¡ˆæª¢æŸ¥æ¸…å–®

ç¢ºèªä»¥ä¸‹æª”æ¡ˆæ˜¯æœ€æ–°ç‰ˆæœ¬ï¼š
- âœ… `preprocess_data.py` - å·²ä¿®æ­£ï¼ˆåªè®€ Line 2ï¼‰
- âœ… `train.py` - å·²ä¿®æ­£ï¼ˆMAPE epsilonï¼‰
- âœ… `model.py` - å·²ä¿®æ­£ï¼ˆSigmoid è¼¸å‡ºç´„æŸï¼‰

---

## ðŸ“ž é©—è­‰æ­¥é©Ÿ

### é è™•ç†å‰

```bash
# æª¢æŸ¥ ground_truth.txt æ ¼å¼
head -3 raw_data/UBFC-rPPG/UBFC_DATASET/DATASET_2/subject1/ground_truth.txt

# æ‡‰è©²çœ‹åˆ° 3 è¡Œä¸åŒçš„æ•¸æ“šï¼š
# Line 1: å°æ•¸å€¼ï¼ˆPPGï¼‰
# Line 2: æ•´æ•¸å€¼ï¼ˆHR, å¦‚ 97, 99, 100ï¼‰
# Line 3: ç§‘å­¸è¨˜æ•¸æ³•ï¼ˆTimestepï¼‰
```

### é è™•ç†å¾Œ

```bash
# æª¢æŸ¥æ¨™ç±¤ç¯„åœ
python -c "
import torch
data = torch.load('data/ubfc_processed.pt')
print(f'Min: {data[\"labels\"].min():.2f}')  # æ‡‰è©² > 50
print(f'Max: {data[\"labels\"].max():.2f}')  # æ‡‰è©² < 130
"
```

### è¨“ç·´ä¸­

```bash
# ç›£æŽ§ç¬¬ä¸€å€‹ epoch çš„ MAE
tail -f logs/training_*.log | grep MAE

# æ‡‰è©²çœ‹åˆ° MAE < 20 BPMï¼ˆå¦‚æžœæ›´å¤§ï¼Œæœ‰å•é¡Œï¼‰
```

---

**å‰µå»ºæ—¥æœŸ**: 2025-01-19
**ç‰ˆæœ¬**: v3.0 - æ­£ç¢ºè®€å– Ground Truth
**ä½œè€…**: Claude Code AIï¼ˆæ„Ÿè¬ç”¨æˆ¶æŒ‡æ­£ï¼ï¼‰
**ç‹€æ…‹**: ðŸ”¥ **ç«‹å³åŸ·è¡Œæ­¤ä¿®æ­£**
